name: Build and Deploy to K3s
# Workflow completo com Testes, Segurança (Trivy) e Deploy

on:
  push:
    branches:
      - main # Roda sempre que houver um push na branch main

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install flask prometheus_client pytest psycopg2-binary

      - name: Run tests
        run: cd app && pytest

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test # Só constrói a imagem se os testes passarem
    permissions:
      contents: read
      packages: write # Permissão para publicar no GitHub Container Registry

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Image Name
        run: |
          echo "IMAGE_NAME=ghcr.io/$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')/metrics-app" >> $GITHUB_ENV

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} # Token gerado automaticamente pelo GitHub

      - name: Build Docker image (Local for Scanning)
        uses: docker/build-push-action@v5
        with:
          context: ./app # Aponta para a pasta do seu app
          load: true # Carrega a imagem para o Docker local em vez de dar push
          tags: ${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'table'
          exit-code: '1' # Quebra o pipeline se encontrar vulnerabilidades
          ignore-unfixed: true # Ignora vulnerabilidades que ainda não têm correção
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH' # Apenas falhas críticas ou altas

      - name: Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: true # Agora sim faz o push
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy:
    name: Deploy to K3s Cluster
    runs-on: ubuntu-latest
    needs: build-and-push # Só roda depois que o job de build for concluído

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Image Name
        run: |
          echo "IMAGE_NAME=ghcr.io/$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')/metrics-app" >> $GITHUB_ENV

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Update Image Name in Manifest
        run: |
          sed -i "s|ghcr.io/YOUR_GITHUB_USERNAME/metrics-app|${{ env.IMAGE_NAME }}|g" k8s/k8s-deployment.yaml

      - name: Set Kubernetes Context
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.K3S_KUBECONFIG }}

      - name: Deploy to K3s
        uses: azure/k8s-deploy@v4
        with:
          skip-tls-verify: true
          manifests: |
            k8s/postgres-secret.yaml
            k8s/postgres.yaml
            k8s/k8s-deployment.yaml
          images: |
            ${{ env.IMAGE_NAME }}:${{ github.sha }}